<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lumea by Ayoola – Player</title>
  <meta name="theme-color" content="#000000" />
  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
    #stage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;overflow:hidden}
    img,video{max-width:100%;max-height:100%;width:100vw;height:100vh;object-fit:cover;display:none}
    #badge{position:fixed;right:12px;bottom:10px;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:10px;font-size:12px}
    #msg{position:fixed;left:12px;bottom:10px;font-size:12px;opacity:.8;color:#f66;max-width:60vw}
  </style>
</head>
<body>
  <div id="stage">
    <img id="img" alt="pub"/>
    <video id="vid" playsinline muted preload="auto"></video>
  </div>
  <div id="badge">Lumea by Ayoola</div>
  <div id="msg"></div>

<script>
(async function(){
  const params = new URLSearchParams(location.search);
  const DEVICE_ID = params.get('id') || 'AYO-0001';
  const CONFIG_URL = `${location.origin}/configs/${DEVICE_ID}.json`;
  const REFRESH_MS = 60000; // recharge la config chaque 60 secondes
  const msg = (t)=> document.getElementById('msg').textContent = t || '';

  const imgEl = document.getElementById('img');
  const vidEl = document.getElementById('vid');

  let playlist = [];
  let idx = 0;

  function normalizeAds(list){
    return (list||[]).map(a=>({
      id: a.id || a.src,
      type: (a.type||'image').toLowerCase(),
      src: a.src,
      duration: (+a.duration>0)?+a.duration: (a.type==='video'?20:10),
      mute: a.mute !== false,
      loop: !!a.loop
    })).filter(a=>a && a.src);
  }

  async function loadConfig(){
    try{
      const res = await fetch(CONFIG_URL, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const cfg = await res.json();
      playlist = normalizeAds(cfg.ads);
      if(playlist.length===0) msg('Aucune pub trouvée.');
      else msg('');
    }catch(e){
      msg('Erreur de configuration ou fichier manquant.');
    }
  }

  async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  async function showImage(ad){
    vidEl.pause(); vidEl.currentTime=0; vidEl.removeAttribute('src'); vidEl.load(); vidEl.style.display='none';
    imgEl.src = ad.src; imgEl.style.display='block';
    await new Promise(r=>{ if(imgEl.complete) return r(); imgEl.onload=r; imgEl.onerror=r; });
    await sleep(ad.duration*1000);
  }

  async function showVideo(ad){
    imgEl.style.display='none'; imgEl.removeAttribute('src');
    vidEl.style.display='block';
    vidEl.src = ad.src;
    vidEl.muted = ad.mute !== false;
    vidEl.loop = !!ad.loop;
    try{ await vidEl.play(); }catch(e){
      vidEl.muted = true;
      try{ await vidEl.play(); }catch(e2){}
    }
    if(vidEl.loop){
      await sleep(ad.duration*1000);
    }else{
      const done = Promise.race([ new Promise(r=> vidEl.onended = r), sleep(ad.duration*1000) ]);
      await done;
    }
    vidEl.pause(); vidEl.currentTime=0;
  }

  async function playLoop(){
    for(;;){
      if(playlist.length===0){ await sleep(1000); continue; }
      const ad = playlist[idx % playlist.length];
      try{
        if(ad.type === 'video') await showVideo(ad);
        else await showImage(ad);
      }catch(e){
        await sleep(500);
      }finally{
        idx++;
      }
    }
  }

  await loadConfig();
  playLoop();
  setInterval(loadConfig, REFRESH_MS);
})();
</script>
</body>
</html>
